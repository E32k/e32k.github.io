<aside id="sidebar">
  {% assign pages = site.pages | sort: "url" %}

  {% assign rendered_folders = "" | split: "" %}

  <ul class="tree">

    {% for page in pages %}
      {% if page.title %}

        {% assign parts = page.url | split: "/" %}
        {% assign depth = parts.size | minus: 2 %}
        {% assign name = parts | last %}
        {% assign folder = parts[depth | minus: 1] %}

        {% if name == "index.html" or name == "" %}
          {% unless rendered_folders contains page.url %}
            <li class="folder depth-{{ depth }}">
              <details>
                <summary>
                  <a href="{{ page.url }}">{{ page.title }}</a>
                </summary>

                <ul>
                  {% for subpage in pages %}
                    {% if subpage.url contains page.url and subpage.url != page.url and subpage.title %}
                      {% assign sub_parts = subpage.url | split: "/" %}
                      {% assign sub_name = sub_parts | last %}

                      {% if sub_name != "index.html" %}
                        <li class="file">
                          <a href="{{ subpage.url }}">{{ subpage.title }}</a>
                        </li>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                </ul>
              </details>
            </li>
          {% endunless %}
        {% endif %}

      {% endif %}
    {% endfor %}

  </ul>
</aside>
